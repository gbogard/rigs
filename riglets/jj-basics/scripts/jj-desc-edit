#!/usr/bin/env bash
# Edit a jj revision's description by piping through a command
# Usage: jj-desc-edit [REVISION] COMMAND [ARGS...]
#   REVISION defaults to @ (current change)
#   COMMAND is the command to pipe the description through
#
# Examples:
#   jj-desc-edit sed 's/foo/bar/g'              # Replace foo with bar
#   jj-desc-edit @ sed 's/WIP/DONE/'            # Edit specific revision
#   jj-desc-edit awk '{print toupper($0)}'     # Convert to uppercase
#   jj-desc-edit perl -pe 's/bug-(\d+)/issue-$1/g'  # Regex replacement

set -euo pipefail

# Parse arguments: optional revision, then command
if [ $# -gt 0 ] && jj show --no-graph "$1" &>/dev/null; then
  revision="$1"
  shift
else
  revision="@"
fi

if [ $# -eq 0 ]; then
  echo "Usage: jj-desc-edit [REVISION] COMMAND [ARGS...]" >&2
  echo "  Pipes the description through COMMAND and updates it" >&2
  exit 1
fi

# Get current description using our jj-desc-read script
current_desc=$(jj-desc-read "$revision")

# Pipe through the provided command
new_desc=$(echo "$current_desc" | "$@")

# Update the description using jj describe --stdin
echo "$new_desc" | jj describe --revision "$revision" --stdin
